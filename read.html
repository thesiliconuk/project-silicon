<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/styles/main.css"> 
    <link rel="stylesheet" href="/styles/reader.css">

    <link href='https://fonts.googleapis.com/css?family=JetBrains Mono' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Kalam" rel='stylesheet'>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
        import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC6eRdhg6EtrRPGA423DJIEIndaWy9UUZA",
            authDomain: "silicon-articles.firebaseapp.com",
            projectId: "silicon-articles",
            storageBucket: "silicon-articles.appspot.com",
            messagingSenderId: "404018682364",
            appId: "1:404018682364:web:4e60dd8548f29231eeba79"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        async function fetchArticle(articleId) {
            const docRef = doc(db, "articles", articleId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const article = docSnap.data();
                const authorRef = doc(db, "users", article.authorId);
                const authorSnap = await getDoc(authorRef);
                const authorName = authorSnap.exists() ? authorSnap.data().name : "Unknown Author";

                document.getElementById('article-title').textContent = article.title;
                document.getElementById('article-author').textContent = `Written by ${authorName}`;
                document.getElementById('article-date').textContent = `Published ${new Date(article.createdAt.seconds * 1000).toDateString()}`;
                document.getElementById('article-banner').src = article.bannerURL;

                // Convert Markdown to HTML
                const articleContentHTML = marked(article.content);
                document.getElementById('article-content').innerHTML = articleContentHTML;
                document.getElementById('title').textContent = `${article.title} | The Silicon`;

                // Fetch and display comments
                fetchComments(articleId);
            } else {
                console.log("No such document!");
            }
        }

        async function fetchComments(articleId) {
            const commentsQuery = query(collection(db, `articles/${articleId}/comments`), orderBy('createdAt', 'desc'));
            const commentsSnapshot = await getDocs(commentsQuery);
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';

            commentsSnapshot.forEach((commentDoc) => {
                const comment = commentDoc.data();
                const commentElement = document.createElement('div');
                commentElement.classList.add('comment');
                commentElement.innerHTML = `
                    <p><strong style="color: #89BEFF;">${comment.authorName}:</strong> ${comment.text}</p>
                `;
                commentsList.appendChild(commentElement);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('a');
            if (articleId) {
                fetchArticle(articleId);
            }

            // Handle comment form submission
            const commentForm = document.getElementById('comment-form');
            commentForm.onsubmit = async (event) => {
                event.preventDefault();
                const commentText = document.getElementById('comment-text').value;
                const user = auth.currentUser;
                if (user) {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    const authorName = userDoc.exists() ? userDoc.data().name : "Anonymous";
                    await addDoc(collection(db, `articles/${articleId}/comments`), {
                        text: commentText,
                        authorName: authorName,
                        createdAt: new Date()
                    });
                    document.getElementById('comment-text').value = '';
                    fetchComments(articleId); // Refresh comments
                } else {
                    alert('You must be logged in to comment.');
                }
            };
        });
    </script>
    <title id="title"></title>
</head>
<body>
    <header class="navbar">
        <a href="/" class="navbar-link">Home</a>
        <a href="/wallpapers" class="navbar-link">Wallpapers</a>
        <a href="#" class="navbar-link">Social Media</a>
        <a href="/about" class="navbar-link">About us</a>

        <!--Signed out-->
        <a href="/signup" id="signup" class="special-navbar-link">Sign up</a>
        <a href="/login" id="login" class="special-navbar-link">Log in</a>

        <!--Signed in-->
        <a href="/account" id="account" class="special-navbar-link">Account</a>
        <a href="/logout" id="logout" class="special-navbar-link">Log out</a>
    </header>

    <div class="article-container">
        <h1 id="article-title"></h1>
        <p id="article-author"></p>
        <p id="article-date"></p>
        <img id="article-banner" src="" alt="Article Banner" style="display: block; width: 50%; border-radius: 20px; margin-left: auto; margin-right: auto;">
        <div id="article-content" style="white-space: pre-wrap;"></div>

        <div class="comments-section">
            <h2>Comments</h2>
            <form id="comment-form">
                <textarea id="comment-text" placeholder="Write a comment..." required></textarea>
                <button type="submit">Submit</button>
            </form>
            <div id="comments-list"></div>
        </div>
    </div>

    <script type="module" src="/scripts/linkeEligibility.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>